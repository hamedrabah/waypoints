<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Waypoints - Drone Flight Planning</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <div class="sidebar-logo">
      <!-- Mock Skydio SVG Logo: Sleek Blue Gradient Ring with Thin White Inner Ring (Palantir-esque) -->
      <svg width="38" height="38" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <radialGradient id="skydioBlueGradient" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#4fc3f7"/>
            <stop offset="100%" stop-color="#00a0f5"/>
          </radialGradient>
        </defs>
        <circle cx="19" cy="19" r="15" stroke="url(#skydioBlueGradient)" stroke-width="4" fill="none" />
        <circle cx="19" cy="19" r="8.5" stroke="#fff" stroke-width="2" fill="none" />
      </svg>
    </div>
    <div class="sidebar-nav">
      <div class="nav-item">
        <a href="#" class="nav-link active" title="Map">
          <i class="bi bi-map"></i>
        </a>
      </div>
      <div class="nav-item">
        <a href="#" class="nav-link" title="Notebook">
          <i class="bi bi-journal-text"></i>
        </a>
      </div>
      <div class="nav-item">
        <a href="https://github.com/hamedrabah/waypoints" target="_blank" class="nav-link" title="Code">
          <i class="bi bi-code-square"></i>
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="app-header">
      <div class="header-title">
        <span>Demo</span>
        <span class="breadcrumb-separator">/</span>
        <span>San Francisco PD</span>
      </div>
    </div>

    <!-- Content Container -->
    <div class="content-wrapper">
      <!-- Input Card -->
      <div class="card mb-4">
        <div class="card-header">
          <div class="nav-bar">
            <div class="nav-item">
              <button class="nav-link active" id="address-nav">
                <i class="bi bi-geo-alt-fill"></i> Address Input
              </button>
            </div>
            <div class="nav-item">
              <button class="nav-link" id="image-nav">
                <i class="bi bi-image-fill"></i> Image Analysis
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Address Input Section -->
          <div class="input-section active" id="address-section">
            <form id="addressForm">
              <div class="mb-3">
                <label for="address" class="form-label">Street Address, Business or Landmark</label>
                <input type="text" class="form-control" id="address" placeholder="Enter a location" required>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-geo-alt"></i> Create Waypoint
                </button>
              </div>
            </form>
          </div>
          
          <!-- Image Upload Section -->
          <div class="input-section" id="image-section">
            <form id="imageForm">
              <div class="uploader-container" id="uploaderContainer">
                <div class="uploader-icon">
                  <i class="bi bi-image"></i>
                </div>
                <div class="uploader-text">
                  <strong>Drop an image here</strong> or click to browse
                </div>
                <input type="file" class="file-input-hidden" id="imageUpload" accept="image/*" required>
              </div>
              
              <div id="imagePreview" class="mb-3 text-center" style="display:none;">
                <img id="previewImg" class="img-fluid rounded" />
                <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeImage">
                  <i class="bi bi-trash"></i> Remove
                </button>
              </div>
              
              <div class="my-3">
                <h6>Or select a sample image:</h6>
                <div class="sample-images-container">
                  <div class="row g-2">
                    <div class="col">
                      <div class="sample-image" data-sample="golden-gate">
                        <img src="images/1.jpg" class="img-fluid" alt="Golden Gate Bridge">
                      </div>
                    </div>
                    <div class="col">
                      <div class="sample-image" data-sample="painted-ladies">
                        <img src="images/2.jpg" class="img-fluid" alt="Painted Ladies">
                      </div>
                    </div>
                    <div class="col">
                      <div class="sample-image" data-sample="lombard-street">
                        <img src="images/3.jpg" class="img-fluid" alt="Lombard Street">
                      </div>
                    </div>
                    <div class="col">
                      <div class="sample-image" data-sample="fishermans-wharf">
                        <img src="images/4.jpg" class="img-fluid" alt="Fisherman's Wharf">
                      </div>
                    </div>
                    <div class="col">
                      <div class="sample-image" data-sample="chinatown">
                        <img src="images/5.jpeg" class="img-fluid" alt="Chinatown">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="d-grid mt-3">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-search"></i> Analyze Image & Create Waypoint
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Main Display Area with 911 Calls Rail and Map -->
      <div class="dashboard-layout">
        <!-- 911 Calls Left Rail -->
        <div class="calls-rail">
          <div class="calls-header">
            <h4>911 CALLS FOR SERVICE</h4>
            <div class="calls-filters">
              <div class="input-group">
                <input type="text" class="form-control" id="callsSearch" placeholder="Search incidents...">
                <button class="btn btn-outline-secondary" type="button" id="callsSearchBtn">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div class="filter-row mt-2">
                <div class="row">
                  <div class="col-6">
                    <select class="form-select" id="callsLimit">
                      <option value="25">25 calls</option>
                      <option value="50" selected>50 calls</option>
                      <option value="100">100 calls</option>
                    </select>
                  </div>
                  <div class="col-6">
                    <select class="form-select" id="callsSeverity">
                      <option value="all" selected>All Severity</option>
                      <option value="high">High Priority</option>
                      <option value="medium">Medium Priority</option>
                      <option value="low">Low Priority</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id="callsList" class="timeline-wrapper">
            <!-- 911 calls will be added here -->
            <div class="text-center p-4 text-muted">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading 911 calls...</p>
            </div>
          </div>
        </div>

        <!-- Results Section with Map -->
        <div id="resultSection" class="map-content">
          <div class="card">
            <div class="card-header">Operational View</div>
            <div class="card-body p-0">
              <div class="analysis-container">
                <!-- Top Panel: Map -->
                <div class="p-3">
                  <div class="map-panel-full">
                    <div id="map" style="height: 500px;"></div>
                  </div>
                </div>
                
                <!-- Bottom Panel: Timeline and Predictions -->
                <div class="dual-panel p-3">
                  <!-- Left Column: Timeline and Details -->
                  <div class="data-column">
                    <div class="info-panel">
                      <div class="info-panel-header">Primary Location Details</div>
                      <div class="info-panel-content">
                        <div class="info-panel-row">
                          <div class="info-panel-label">Address:</div>
                          <div class="info-panel-value" id="formattedAddress"></div>
                        </div>
                        <div class="info-panel-row">
                          <div class="info-panel-label">Coordinates:</div>
                          <div class="info-panel-value" id="coordinates"></div>
                        </div>
                        <div class="info-panel-row">
                          <div class="info-panel-label">Status:</div>
                          <div class="info-panel-value" id="waypointStatus"></div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="info-panel">
                      <div class="info-panel-header">Waypoints List</div>
                      <div class="timeline-wrapper" id="waypointsList">
                        <!-- Waypoints will be added here -->
                      </div>
                      <div class="p-3">
                        <button id="exportWaypointsBtn" class="btn btn-primary">
                          <i class="bi bi-download"></i> Export Waypoints
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Right Column: Predictions or Uploaded Image -->
                  <div class="data-column">
                    <div id="uploadedImageContainer" class="image-panel">
                      <!-- Uploaded image will be displayed here -->
                    </div>
                    <div id="predictionsContainer">
                      <!-- Predictions content will be inserted here -->
                    </div>
                  </div>
                </div>
                
                <!-- Street View Container -->
                <div id="street-view-container" style="display: none;" class="p-3">
                  <div class="info-panel-header mb-2">Street View</div>
                  <div id="street-view"></div>
                  <button id="closeStreetView" class="btn btn-sm btn-secondary mt-2">
                    <i class="bi bi-x-lg"></i> Close Street View
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Error Section -->
      <div class="row" id="errorSection" style="display: none;">
        <div class="col-md-12">
          <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Error</h4>
            <p id="errorMessage"></p>
          </div>
        </div>
      </div>

      <!-- Old 911 Calls Section (now hidden and replaced with left rail) -->
      <div id="callsSection" style="display: none;">
        <!-- This section is now replaced by the left rail -->
      </div>

      <div class="footer">
        <!-- Footer content removed -->
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const script = document.createElement('script');
      script.src = 'app.js';
      script.onload = function() {
        // Fetch the Google Maps API key from the server
        fetch('/.netlify/functions/api/maps-api-key')
          .then(response => response.json())
          .then(data => {
            if (data.key) {
              // Create the script element with proper async attribute
              const mapsScript = document.createElement('script');
              mapsScript.src = `https://maps.googleapis.com/maps/api/js?key=${data.key}&libraries=places&callback=initMap`;
              mapsScript.async = true;
              mapsScript.defer = true;
              
              // Add a warning handler for the PlaceAutocomplete migration
              window.gm_authFailure = function() {
                console.error('Google Maps authentication failed. Please check your API key.');
              };
              
              document.head.appendChild(mapsScript);
            } else {
              console.error('Google Maps API key not available');
              alert('Google Maps API key is not configured. Map functionality will be limited.');
            }
          })
          .catch(error => {
            console.error('Error loading Google Maps API key:', error);
          });
      };
      document.body.appendChild(script);
    });
  </script>
</body>
</html> 